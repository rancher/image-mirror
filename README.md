# Rancher Artifact Mirror

This repo is dedicated to mirroring artifacts from other organizations to the
places they need to be for Rancher and its associated projects to use them.

> [!NOTE]
> This repository used to be called `image-mirror`; it was renamed to better reflect its use cases, see [this](https://github.com/rancher/rancher/issues/52259) issue for more information.

## Overview

`regsync` is used for mirroring OCI artifacts from one repository to another. `regsync`
is configured via `regsync.yaml`. `regsync.yaml` is generated by running the
`generate-regsync` subcommand of the Go code in `tools/`, using `config.yaml` as
input. You can build the latest version of this code to `bin/artifact-mirror-tools`
using `scripts/build-tools.sh`. Thus, your workflow might look like this:
```
scripts/build-tools.sh
bin/artifact-mirror-tools generate-regsync
```
Once `regsync.yaml` has been updated, you may run `regsync` via the command
```
regsync once --verbosity error --config regsync.yaml --missing
```
`autoupdate.yaml` is used to configure automatic updates for artifacts. When
an update is found, the automation creates a pull request that a human user
can then review and merge. See [`autoupdate.yaml`](#autoupdateyaml) for
more information.

### Adding New Artifacts

When adding new OCI artifacts to the repo, please indicate so in the pull request.
You will need to submit a request to EIO, who will create the repo in
DockerHub. If this is not done, mirroring the artifact will fail. Nothing
special needs to be done for mirroring a new artifact to the Rancher Prime
registry.

### Artifact Prefixes

Every artifact that is mirrored by this repository should have a prefix that
communicates some information about it. The only exception is legacy artifacts:
in the past the Rancher project did not add prefixes to mirrored artifacts.
All new artifacts must have a prefix.

| Prefix | Meaning |
| ------------- | ------------- |
| `mirrored-` | The artifact was mirrored from somewhere else. This is the default choice, and is used when the below prefixes do not apply.
| `appco-` | The artifact originated in the [SUSE Application Collection](https://apps.rancher.io/). We use artifacts from the application collection because they have a better security posture.
| `hardened-` | The artifact has been hardened. This repository does not concern itself with hardened artifacts.

## File Purpose/Structure

### `regsync.yaml`

`regsync.yaml` is mostly for use by `regsync`. It is generated from `config.yaml`,
and is not very easy to read. It should never be modified directly. It can,
however, be useful for checking that `config.yaml` changes will have the expected
effect on mirroring.

### `regsync-daily.yaml`

`regsync-daily.yaml` is a special case for artifacts that must be mirrored daily.
Avoid using it if possible - it does not get you the benefits of using `config.yaml`
and `artifact-mirror-tools`. There should be a very good reason for using it, if you
do. `regsync-daily.yaml` is managed manually, and not touched by any automation.

As of the time of writing, `regsync-daily.yaml` is used only for Neuvector images.
The Neuvector images use it because the daily image builds incorporate the latest CVE
information. We must mirror the `latest` tag of these images each day for this
information to be available to users.

### `config.yaml`

#### `Repositories`

`Repositories` describes the repositories that artifact-mirror interfaces with.
This section roughly correlates to the `creds` section of `regsync.yaml`.

| Field | Required | Description |
| ------------- | ------------- |------------- |
| `BaseUrl` | yes | The base URL for the repository. Appending `/` plus an artifact name should be a valid artifact reference.
| `Password` | yes | The password to use when authenticating against the registry. See [the regsync documentation](https://regclient.org/usage/regsync/) for more details.
| `Registry` | yes | The registry URL. See [the regsync documentation](https://regclient.org/usage/regsync/) for more details.
| `ReqConcurrent` | no | The number of concurrent requests that are made to this registry. See [the regsync documentation](https://regclient.org/usage/regsync/) for more details.
| `DefaultTarget` | no | Whether the Repository is used as a target repository for a given artifact when the `TargetRepositories` field of the `Artifact` is not set.
| `Username` | yes | The username to use when authenticating against the registry. See [the regsync documentation](https://regclient.org/usage/regsync/) for more details.

#### `Artifacts`

`Artifacts` describes the artifacts that we want to mirror to each target
repository.

| Field                | Required | Description |
|----------------------| ------------- |------------- |
| `DoNotMirror`        | no | Set to `true` to exclude the entire `Artifact` from regsync.yaml. Alternatively, set to an array of strings to specify tags to exclude from regsync.yaml.
| `SourceArtifact`     | yes | The source artifact. If there is no host, the artifact is assumed to be from Docker Hub.
| `Tags`               | yes | The tags to mirror.
| `TargetArtifactName` | no | By default, the target artifact name is derived from the source artifact, and is of the format `mirrored-<org>-<name>`. For example, `banzaicloud/logging-operator` becomes `mirrored-banzaicloud-logging-operator`. However, there are some artifacts that do not follow this convention - this field exists for these cases. New artifacts should not set this field.
| `TargetRepositories` | no | Repositories to mirror the artifact to. Repositories are specified via their `BaseUrl` field. If not specified, the `Artifact` is mirrored to all Repositories that have `DefaultTarget` set to true.

### `autoupdate.yaml`

`autoupdate.yaml` defines configuration for automatically updating artifact tags
based on various update strategies that monitor sources for new tags. Each
entry specifies a strategy for finding tags of artifacts to potentially add to
`config.yaml`, which are then submitted as pull requests.

| Field           | Required | Description |
|-----------------| ------------- |------------- |
| `Name`          | yes | A unique identifier for this autoupdate entry. Used for logging and generating branch names for pull requests.
| `GithubRelease` | no | See [`GithubRelease`](#githubrelease).
| `HelmLatest`    | no | See [`HelmLatest`](#helmlatest).
| `Registry`      | no | See [`Registry`](#registry).
| `Reviewers`     | yes | A list of GitHub users or teams that own the autoupdate entry. Teams should be in the format `org/team-slug`.

#### `GithubRelease`

The `GithubRelease` strategy fetches all release tags that matches the VersionConstraint from a GitHub
repository and applies it to the specified artifacts.
If LatestOnly is true, it only fetches from the latest release and does not consider the VersionConstraint.

| Field               | Required | Description |
|---------------------|----------|------------- |
| `Owner`             | yes      | The GitHub repository owner/organization.
| `Repository`        | yes      | The GitHub repository name.
| `Artifacts`         | yes      | See [`Artifacts`](#Artifacts).
| `LatestOnly`        | no       | If true, get only the tag from the latest github release.
| `VersionConstraint` | no       | A SemVer constraint used to filter the github releases.
| `VersionRegex`      | no       | If specified, only matching release tags will be considered. If a capture group is present, only its contents will be passed on.

##### `Artifacts`

A list of artifacts to be updated with the latest release tag. Each artifact will get the same tag as the GitHub release.

| Field                | Required | Description |
|----------------------| ------------- |------------- |
| `SourceArtifact`     | yes | The GitHub repository name.
| `TargetArtifactName` | no | The TargetArtifactName of the artifact in `config.yaml` that you want to update.

#### `HelmLatest`

The `HelmLatest` strategy templates out the latest version of configured
Helm charts and extracts artifact references from the rendered manifests. It
recursively searches for fields with an "image" key in the templated YAML
output.

| Field           | Required | Description |
|-----------------| ------------- |------------- |
| `HelmRepo`      | yes | The URL of the Helm chart repository.
| `Charts`        | yes | A map where keys are the charts to template, and values are another map from environment name to lists of helm values to `--set` in that environment. `helm template` is run once for each environment.
| `Artifacts`     | no | Used to map a given update artifact to an entry in `config.yaml`. There may be multiple entries that have the same `SourceArtifact`, but different `TargetArtifactName`s, so we need to choose which one receives the update artifact.
| `ImageDenylist` | no | A list of images to exclude from the results.

#### `Registry`

The `Registry` strategy fetches all artifact tags that matches the `VersionFilter` from a registry defined in the `Artifacts` provided.
Supported registries are:
* Suse Container Registry (registry.suse.com)
* Docker Hub
* Quay.io
* K8s registry (registry.k8s.io)
* GitHub Container Registry (ghcr.io)
* Google Container Registry (gcr.io)

| Field           | Required | Description |
|-----------------|----------|------------- |
| `Artifacts`        | yes      | Used to map a given update artifact to an entry in `config.yaml`. There may be multiple entries that have the same `SourceArtifact`, but different `TargetArtifactName`s, so we need to choose which one receives the update artifact.
| `Latest`        | no       | A flag to only use the latest tag. This only works if all tags are in semver format.
| `VersionFilter` | no       | A regex to match against the artifact tags fetched from the registry.
